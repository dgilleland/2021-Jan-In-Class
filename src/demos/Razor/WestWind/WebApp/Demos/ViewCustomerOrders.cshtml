@using WebApp.Data
@using WestWindSystem.BLL
@{
    Page.Title = "Customer Orders";
    Layout = "~/_Layout.cshtml";
    string customerId = Request.QueryString["cid"];

    // Create Controller class
    var controller = new CustomerController();
    // Call the FindCustomer method
    Customer customer = controller.FindCustomer(customerId);
    // Check the results
    if (customer == null)
    {
        // If we don't get a customer back, we'll redirect to the CustomerSearch page
        Response.Redirect("~/Demos/CustomerSearch.cshtml", true); // the "true" parameter says to stop processing and just redirect
    }
}

<h1>Customer Orders</h1>

<div class="row">
    @*Bootstrap uses a 12-column grid layout for each row*@
    <div class="col-md-3">
        <h2>@customer.CompanyName</h2>
        <p>@customer.ContactName - @customer.Phone</p>
        <form method="post" action="~/Demos/ManageOrders.cshtml">
            <input type="hidden" name="customerId" value="@customerId" />
            <button type="submit" name="action" value="PrepOrder">Add Order</button>
        </form>
    </div>
    <div class="col-md-9">
        <h2>Orders</h2>
        @{ 
            { // TODO: <--- clean up extra braces ....
                // I'll use a C# LINQ statement to query the database for orders belonging to a specific customer
                var orderController = new OrdersController();
                var result = orderController.GetCustomerOrders(customerId);

                <table class="table table-hover">
                    <thead>
                        <tr>
                            <th>Edit</th>
                            <th>Order Date</th>
                            <th>Ship Name</th>
                            <th>Shipped</th>
                            <th>Freight</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach(var order in result)
                        {
                            <tr>
                                <td>
                                    <form method="post" action="~/Demos/ManageOrders.cshtml">
                                        <input type="hidden" name="customerId" value="@customerId" />
                                        <input type="hidden" name="orderId" value="@order.OrderID" />
                                        <button type="submit" name="action" value="EditOrder">Edit</button>
                                    </form>
                                </td>
                                <td>
                                    @(order.OrderDate.HasValue ? 
                                      order.OrderDate.Value.ToShortDateString() : 
                                      string.Empty)
                                </td>
                                <td>@order.ShipName</td>
                                <td><input type="checkbox" checked="@order.Shipped" /></td>
                                <td>
                                    @if (order.Freight.HasValue)
                                    {
                                        <text>@order.Freight.Value.ToString("C")</text>
                                    }
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            }
        }
    </div>
</div>