@using WebApp.Data
@{
    Page.Title = "Manage Customer Order";
    Layout = "~/_Layout.cshtml";

    // Grabbing information POSTed to this page
    // Notice that ALL of the information submitted by the browser is sent as a string
    // - HTTP/HTTPS - Always sends data as text
    string action = Request.Form[nameof(action)];  // Notice that I'm starting to avoid "magic strings"
    string customerId = Request.Form[nameof(customerId)];
    string orderId = Request.Form[nameof(orderId)];
    string repId = Request.Form[nameof(repId)];
    string orderDate = Request.Form[nameof(orderDate)];
    string requiredBy = Request.Form[nameof(requiredBy)];
    string paymentDueBy = Request.Form[nameof(paymentDueBy)];
    string freight = Request.Form[nameof(freight)];
    string shipped = Request.Form[nameof(shipped)];
    string shipName = Request.Form[nameof(shipName)];
    string shipTo = Request.Form[nameof(shipTo)];
    string comments = Request.Form[nameof(comments)];

    string feedback = string.Empty;

    if (IsPost)
    {
        switch (action)
        {
            case "PrepOrder": // This is a new order where we know who the customer is
                break;
            case "EditOrder": // This is an existing order where we know the customer & order id
                {
                    using(var context = new WestWindContext())
                    {
                        Order existing = context.Orders.Find(int.Parse(orderId));
                        if(existing != null)
                        {
                            // set all the variables to the contents of the Order object
                            repId = existing.SalesRepID.ToString();
                            if (existing.OrderDate.HasValue)
                            {
                                orderDate = existing.OrderDate.Value.ToString("yyyy-MM-dd");
                            }
                            if (existing.RequiredDate.HasValue)
                            {
                                requiredBy = existing.RequiredDate.Value.ToString("yyyy-MM-dd");
                            }
                            if (existing.PaymentDueDate.HasValue)
                            {
                                paymentDueBy = existing.PaymentDueDate.Value.ToString("yyyy-MM-dd");
                            }
                            freight = existing.Freight.ToString();
                            shipped = existing.Shipped ? "on" : string.Empty; // ternary expression
                            shipTo = existing.ShipAddressID.ToString();
                            comments = existing.Comments;

                        }
                    }
                    break;
                }
            case "AddOrder": // This is where we want to add the order to the database
                {   // These "extra" curly braces produce a "scope" that allows for variable names to not be "redeclared" inside the case blocks
                    using (var context = new WestWindContext())
                    {
                        // 1) Construct an Order object from the data that was supplied in the web form
                        // We won't need to set the new order's .OrderId because that will be generated by the database
                        Order newOrder = BuildOrderEntity(customerId, repId, orderDate, requiredBy, paymentDueBy, freight, shipTo, shipName, shipped, comments);

                        // 2) Add this to the "virtual" database (our DbContext object)
                        context.Orders.Add(newOrder);
                        // 3) Saving the changes to the "actual" database
                        context.SaveChanges(); // This is when the actual SQL INSERT occurs
                        // 4) Give some kind of feedback to the user
                        //    Show the OrderID that was generated by the database
                        orderId = newOrder.OrderID.ToString(); // the .OrderID is generated by the database
                                                               //    Also put up some text message that the Add Order succeeded
                        feedback = $"Your new order was generated with an order id of {orderId}";
                    }
                    break;
                }
            case "UpdateOrder": // We want to change the data in the database
                {
                    using (var context = new WestWindContext())
                    {
                        // 1) Construct an Order object from the data that was supplied in the web form
                        Order updatedOrder = BuildOrderEntity(customerId, repId, orderDate, requiredBy, paymentDueBy, freight, shipTo, shipName, shipped, comments);
                        updatedOrder.OrderID = int.Parse(orderId);
                        // 2) Note the changes to the order data
                        var existing = context.Entry(updatedOrder);  // Associate the updatedOrder with an existing order
                        existing.State = System.Data.Entity.EntityState.Modified; // Note that the data for this order has changed
                        // 3) Save the changes to the actual database
                        context.SaveChanges();
                        // 4) Give some kind of feedback to the user.
                        feedback = $"Order {orderId} has been updated.";
                    }
                    break;
                }
            case "DeleteOrder": // We want to remove the data in the database
                {
                    using(var context = new WestWindContext())
                    {
                        // 1) Find the order
                        Order existingOrder = context.Orders.Find(int.Parse(orderId)); // This will grab the order from the db
                        // 2) Mark that order for deletion
                        context.Orders.Remove(existingOrder);
                        // 3) Save the changes to the database
                        context.SaveChanges();
                        // 4) Feedback to the user
                        feedback = $"The order {orderId} has been removed.";
                        customerId = string.Empty;
                        orderId = string.Empty;
                        repId = string.Empty;
                        orderDate = string.Empty;
                        requiredBy = string.Empty;
                        paymentDueBy = string.Empty;
                        freight = string.Empty;
                        shipped = string.Empty;
                        shipName = string.Empty;
                        shipTo = string.Empty;
                        comments = string.Empty;
                    }
                    break;
                }
            case "ClearForm": // We want to remove the data in the database
                customerId = string.Empty;
                orderId = string.Empty;
                repId = string.Empty;
                orderDate = string.Empty;
                requiredBy = string.Empty;
                paymentDueBy = string.Empty;
                freight = string.Empty;
                shipped = string.Empty;
                shipName = string.Empty;
                shipTo = string.Empty;
                comments = string.Empty;
                break;
            default:
                break;
        }
    }
}

<h1>Manage Orders</h1>

<form method="post">
    <div class="row">
        <div class="col">
            @{ 
                int throwaway;
                bool hasOrderId = int.TryParse(orderId, out throwaway);
            }
            <button type="submit" name="@nameof(action)" value="AddOrder" disabled="@(hasOrderId)" class="btn btn-primary">Add Order</button>
            <button type="submit" name="@nameof(action)" value="UpdateOrder" disabled="@(!hasOrderId)" class="btn btn-success">Update Order</button>
            <button type="submit" name="@nameof(action)" value="DeleteOrder" disabled="@(!hasOrderId)" class="btn btn-danger">Delete Order</button>
            <button type="reset" class="btn btn-secondary">Reset</button>
            <button type="submit" name="@nameof(action)" value="ClearForm" class="btn btn-warning">Clear Form</button>
            <br />
            <blockquote>
                @feedback
            </blockquote>
        </div>
    </div>
    <div class="row">
        <div class="col-md-6">
            <label>
                Order ID:
                <!-- Using a disabled textbox to show (but not edit) the Order ID-->
                <input type="text" value="@orderId" disabled class="form-control" />
                <!-- Using a hidden input to be able to submit the Order ID back to the web server -->
                <input type="hidden" name="@nameof(orderId)" value="@orderId" class="form-control" />
            </label>
            <br /><br />
            <label>
                Sales Rep:
                @using (var context = new WestWindContext())
                {
                    var employees = context.Employees.ToList();
                    <select name="@nameof(repId)" class="form-control">
                        <option value="">[Select a ]</option>
                        @foreach (var person in employees)
                        {
                            <option value="@person.EmployeeID" selected="@(person.EmployeeID.ToString() == repId)">@person.FirstName @person.LastName</option>
                        }
                    </select>
                }
            </label>
            <br /><br />
            <label>
                Customer:
                @using (var context = new WestWindContext())
                {
                    // Get a list of the customers for my drop-down
                    var customers = context.Customers.ToList(); // Get all the customers as a List<Customer>

                    <select name="@nameof(customerId)" class="form-control" required>
                        <option value="">[Select a Customer]</option>
                        @foreach (var company in customers)
                        {
                            // Add in an entry in the drop-down for each customer
                            <option value="@company.CustomerID" selected="@(customerId == company.CustomerID)">@company.CompanyName</option>
                        }
                    </select>
                }
            </label>
            <br /><br />
            <label>
                Order Date:
                <input type="date" name="@nameof(orderDate)" value="@(orderDate)" class="form-control" />
            </label>
            <br /><br />
            <label>
                Required By:
                <input type="date" name="@nameof(requiredBy)" value="@(requiredBy)" class="form-control" />
            </label>
            <br /><br />
            <label>
                Payment Due Date:
                <input type="date" name="@nameof(paymentDueBy)" value="@(paymentDueBy)" class="form-control" />
            </label>
        </div>

        <div class="col-md-6">
            <label>
                Freight:
                <input type="text" name="@nameof(freight)" value="@freight" class="form-control" />
            </label>
            <br /><br />
            <label>
                Shipped:
                <input type="checkbox" name="@nameof(shipped)" checked="@(shipped == "on")" /> Yes
            </label>
            <br /><br />
            <label>
                Ship Name:
                <input type="text" name="@nameof(shipName)" value="@shipName" class="form-control" />
            </label>
            <br /><br />
            <label>
                Ship Address:
                <select name="@nameof(shipTo)" class="form-control">
                    <option value="">[Select a ]</option>
                    @using (var context = new WestWindContext())
                    {
                        var places = context.Addresses.ToList();
                        foreach (var address in places)
                        {
                            <option value="@address.AddressID" selected="@(address.AddressID.ToString() == shipTo)">
                                @address.Street - @address.City
                            </option>
                        }
                    }
                </select>
            </label>
            <br /><br />
            <label>
                Comments:
                <textarea name="@nameof(comments)" rows="4" class="form-control">@comments</textarea>
            </label>
        </div>
    </div>
</form>

@functions {
    /// <summary>
    /// Construct an Order object based on the string data sent in through the parameters
    /// </summary>
    /// <param name="customerId"></param>
    /// <param name="repId"></param>
    /// <param name="orderDate"></param>
    /// <param name="requiredBy"></param>
    /// <param name="paymentDueBy"></param>
    /// <param name="freight"></param>
    /// <param name="shipTo"></param>
    /// <param name="shipName"></param>
    /// <param name="shipped"></param>
    /// <param name="comments"></param>
    /// <returns></returns>
    public Order BuildOrderEntity(string customerId, string repId, string orderDate, string requiredBy, string paymentDueBy, string freight, string shipTo, string shipName, string shipped, string comments)
    {
        Order newOrder = new Order();
        // Here, I'm setting the property values after instantiating the object
        newOrder.CustomerID = customerId;
        int temp;
        if (int.TryParse(repId, out temp))
        {
            newOrder.SalesRepID = temp;
        }
        DateTime tempDate;
        if (DateTime.TryParse(orderDate, out tempDate))
        {
            newOrder.OrderDate = tempDate;
        }
        if (DateTime.TryParse(requiredBy, out tempDate))
        {
            newOrder.RequiredDate = tempDate;
        }
        if (DateTime.TryParse(paymentDueBy, out tempDate))
        {
            newOrder.PaymentDueDate = tempDate;
        }
        decimal tempMoney;
        if (decimal.TryParse(freight, out tempMoney))
        {
            newOrder.Freight = decimal.Parse(freight);
        }
        if (int.TryParse(shipTo, out temp))
        {
            newOrder.ShipAddressID = int.Parse(shipTo);
        }
        newOrder.ShipName = shipName;
        newOrder.Shipped = (shipped == "on"); // (shipped == "on") gives a bool result
        newOrder.Comments = comments;

        return newOrder;
    }
}